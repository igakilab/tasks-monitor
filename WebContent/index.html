<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>

		<title>DashBoard</title>

		<link href="css/bootstrap.min.css" rel="stylesheet"/>
		<link rel="stylesheet" href="css/reset.css"><!-- CSS reset -->
		<link rel="stylesheet" href="css/htimeline.css"><!-- Resource style -->
		<script src="js/modernizr.js"></script><!-- Modernizr -->
	</head>
	<body style="padding-top: 50px;">
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collabpsed"
					data-toggle="collapse" data-target="#navbar"
					aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#">Tasks Monitor</a>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav">
						<li><a href="boards.html">ボードリスト</a>
						<li class="active"><a href="javascript:void(0)">dashboard</a></li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container">
			<div class="page-header">
				<h1 style="display:inline;">
					<span class="board-title"></span>&nbsp;<small>dashboard</small>
				</h1>
			</div>

			<div class="row col-md-12">
				<span>参加メンバー:
					<span class="members-btn-wrapper btn-group" role="group">
					</span>
				</span>&nbsp;

				<a class="btn btn-default sprint-history-btn" role="button">
					<span class="glyphicon glyphicon-time"></span> スプリント履歴
				</a>

				<a class="btn btn-default board-settings-btn" role="butotn">
					<span class="glyphicon glyphicon-wrench"></span> 設定
				</a>
			</div>

			<div class="row col-md-12 text-right">
				最終更新日時: <span class="last-update-date"></span>&nbsp;&nbsp;
				<button type="button" class="btn btn-default btn-sm board-update-btn">
					<span class="glyphicon glyphicon-refresh"></span>
				</button>
			</div>
		</div>

		<div class="container">
			<div style="text-align:center;">
				<div class="row">
					<div class="col-md-4">
						<h3>次の目標日</h3>
						<span class="finish-date"></span>
					</div>
					<div class="col-md-8">
						<h3 id="taskProgressMsg">現在の進捗</h3>
						<div class="progress">
							<div id="taskProgress" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
							</div>
						</div>
					</div>
				</div>


				<div class="alert-div"></div>

				<!-- <div class="container"> -->
					<div class="row col-md-12">
						<div id="n-timeline" style="padding-top:1.5em;"></div>
					</div>
				<!-- </div> -->

<!-- 				<div class="sprint-cards"> -->
<!-- 				<div class="row"> -->
<!-- 					<section class="cd-horizontal-timeline"> -->
<!-- 					<div class="col-md-3"> -->

<!-- 						<ol style="margin: 0 auto"> -->
<!-- 							<li><h2>aaaaa</h2></li>カード名かナンバリング -->
<!-- 						</ol> -->
<!-- 					</div> -->
<!-- 					<div class="col-md-9"> -->
<!-- 							<div class="timeline">タイムライン表示本体 main.jsで制御 -->
<!-- 								<div class="events-wrapper"> -->
<!-- 									<div class="events"> -->
<!-- 										<ol id="bb">注:ol要素にidを付けないと表示されない idは#ナンバリングでいいかも？ -->
<!-- 											<li><a href="#0" data-date="2016/10/30" class="selected">10/30</a></li> data-date属性の形式はYYYY/MM/DD -->
<!-- 											<li><a href="#0" data-date="2016/10/31">10/31</a></li>					ただし先頭の0は抜くように　日付の判定ができなくなるので -->
<!-- 											<li><a href="#0" data-date="2016/11/1">11/01</a></li>	class="selected"は日付やカードの移動状況によって移動 -->
<!-- 											<li><a href="#0" data-date="2016/11/2">11/02</a></li>	参考 main.js:49,61,66 -->
<!-- 											<li><a href="#0" data-date="2016/11/3">11/03</a></li> -->
<!-- 											<li><a href="#0" data-date="2016/11/4">11/04</a></li> -->
<!-- 											<li><a href="#0" data-date="2016/11/5">11/05</a></li> -->
<!-- 										</ol> -->
<!-- 										<span id="bb" class="filling-line" aria-hidden="true"></span>　バー表示 日付によって動く -->
<!-- 									</div> .events -->
<!-- 								</div> .events-wrapper -->
<!-- 							</div> .timeline -->
<!-- 					</div> -->
<!-- 					</section> -->
<!-- 				</div> -->

<!-- 				<div class="row"> -->
<!-- 					<section class="cd-horizontal-timeline"> -->
<!-- 					<div class="col-md-3"> -->
<!-- 						<ol style="margin: 0 auto"> -->
<!-- 							<li><h2>bbbbb</h2></li> -->
<!-- 						</ol> -->
<!-- 					</div> -->
<!-- 					<div class="col-md-9"> -->
<!-- 							<div class="timeline"> -->
<!-- 								<div class="events-wrapper"> -->
<!-- 									<div class="events"> -->
<!-- 										<ol id="cc"> -->
<!-- 											<li><a href="#0" data-date="2016/10/28" class="selected ; doing">10/28<br>Doing登録</a></li> -->
<!-- 											<li><a href="#0" data-date="2016/10/29" >10/29</a></li> -->
<!-- 											<li><a href="#0" data-date="2016/10/30">10/30</a></li> -->
<!-- 											<li><a href="#0" data-date="2016/10/31" class="done">10/31<br>Done登録</a></li> -->
<!-- 											<li><a href="#0" data-date="2016/11/1">11/01</a></li>	doing,doneはa要素にクラス追加で対応 制御jsの判定で使う -->
<!-- 											<li><a href="#0" data-date="2016/11/2">11/02</a></li>	クラス追加すればマーカーが付く -->
<!-- 											<li><a href="#0" data-date="2016/11/3">11/03</a></li> -->
<!-- 										</ol> -->
<!-- 										<span id="cc" class="filling-line" aria-hidden="true"></span> -->
<!-- 									</div> .events -->
<!-- 								</div> .events-wrapper -->
<!-- 							</div> .timeline -->
<!-- 					</div> -->
<!-- 					</section> -->
<!-- 				</div> -->
<!-- 				</div> -->

				<div class="row text-right">
					<a class="btn btn-default sprint-plan-btn" role="button">
					イテレーション開始&amp;変更</a>
					<a class="btn btn-primary sprint-close-btn disabled" role="button">
					振り返りへ</a>
				</div>

				<div class="row">
					<div class="col-md-4">
						<h2>ToDo
							<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal">追加</button>
						</h2>
						<ul id="todoList" class="list-group"></ul>
					</div>
					<div class="col-md-4">
						<h2>Doing</h2>
						<ul id="doingList" class="list-group"></ul>
					</div>
					<div class="col-md-4">
						<h2>Done</h2>
						<ul id="doneList" class="list-group"></ul>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modallabel" aria-hidden="true">
			<div class="modal-dialog" role="dodument">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="modallabel">新しいタスクの追加</h4>
					</div>
					<div class="modal-body">
						<form id="newCardForm">
							<div class="form-group">
								<label for="newCardNameInput">カード名</label>
								<input type="text" class="form-control" id="newCardNameInput" name="name"/>
							</div>
							<div class="form-group">
								<label for="newCardDescInput">説明</label>
								<input type="text" class="form-control" id="newCardDescInput" name="desc"/>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-success add-new-card-btn"
							data-dismiss="modal">新規追加</button>
					</div>
				</div>
			</div>
		</div>

		<div id="mpWorkspace"></div>

		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/jquery.serialize.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/jquery.mobile.custom.min.js"></script>
		<script src="js/modal-prompt.js"></script>
		<script src="js/htimeline.js"></script> <!-- Resource jQuery -->
		<script src="js/util.js"></script>
		<script src="dwr/engine.js"></script>
		<script src="dwr/util.js"></script>
		<script src="dwr/interface/DashBoard.js"></script>

		<script src="dashboard.js"></script>

		<script src="js/sprint-builder.js"></script>
		<script src="dwr/engine.js"></script>
		<script src="dwr/util.js"></script>
		<script src="dwr/interface/SprintPlanner.js"></script>
		<script src="sprint.js"></script>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

		<script>
		$(document).ready(function(){
			//URLパラメータを取得する("URLアドレス?xxx=vvv&..."のやつ)
			var params = Util.getUrlParameters();

			//ボードIDの値をパラメータから取り出す
			var boardId = params.bid;

			//ボードIDが未定義(undefined)のとき、アラートを表示して終了
			if( typeof boardId === 'undefined' ){
				Util.showAlertToDiv($("<span></span>").append(
					"ボードIDを指定してください  ",
					$("<a></a>").attr("href", "boards.html").text("ボード一覧へ"))
				);
				return;
			}

			//かんばんの情報を取得する
			DashBoard.getDashBoardData(boardId, {
				//処理が完了したときに呼び出されるコールバック関数
				//dataにかんばんの情報が返却される
				callback: function(data){
					/*
					 * 返却されるデータ: {
					 *  boardId: <ボードのID>
					 *  boardName: <ボードの名前>
					 *  boardUrl: <ボードのURL>
					 *  kanban: {
					 *  	todo: <todoのタスクリスト>
					 *  	doing: <doingのタスクリスト>
					 *  	done: <doneのタスクリスト>
					 * }
					 *  sprintId: <スプリントのID>
					 *  beginDate: <スプリントの開始日>
					 *  finishDate: <スプリントの終了日>
					 *  sprintCards: [{
					 *  	finished: <終了していたらtrue>
					 *  	createdAt: <タスク(カード)の作成された日時>
					 *  	movedDoingAt: <doingに移動した日時>
					 *  	movedDoneAt: <doneに移動した日時>
					 *  }, ...]
					 * }
					*/

					$(".sprint-history-btn").attr("href", "history.html?bid=" + data.boardId);
					$(".sprint-plan-btn").attr("href", "sprint.html?bid=" + data.boardId);
					$(".board-settings-btn").attr("href", "boardsettings.html?bid=" + data.boardId);
					$(".board-update-btn").on('click', {bid: data.boardId}, function(e){
						Util.showAlertToDiv("更新中...", "warning");
						DashBoard.updateBoardData(e.data.bid, function(){
							location.reload();
						});
					});

					if( data.sprintId != null ){
						var remainedCount = 0;
						data.sprintCards.forEach(function(e){
							if( !e.finished ) remainedCount++;
						});

						var closeSprint = function(){
							$(".sprint-close-btn").off('click')
								.text("処理中...").addClass("disabled");
							DashBoard.closeCurrentSprint(boardId, {
								//正常に終了した時の動作
								callback: function(sid) {
									location.href = "feedback.html?sid=" + sid;
								},
								//異常終了した時の動作
								errorHandler: function(msg){
									alert(msg);
								}
							});
						}

						$(".sprint-close-btn")
							.removeClass("disabled")
							.on('click', {rem: remainedCount}, function(e){
								if( e.data.rem > 0 ){
									var mp = new ModalPrompt($("#mpWorkspace"));
									mp.onButtonPressed = function(res){
										if( res ) closeSprint();
									}
									mp.$submitButton.removeClass("btn-primary").addClass("btn-warning");
									mp.$cancelButton.text("Cancel");
									mp.confirm($("<div></div>")
										.html("未完了のタスクがあります<br/>イテレーションを終了してもよろしいですか?"));
								}else{
									closeSprint();
								}
							});
					}

					//putMemberTasksButtonを呼ぶ
					$(".members-btn-wrapper").empty();
					putMemberTasksButton($(".members-btn-wrapper"), data.members);

					//showDashBoardを呼ぶ
					google.charts.load("current", {packages:["timeline"]});
					google.charts.setOnLoadCallback(function(){
						showDashBoard(data);
					});
				},

				//処理が異常終了したときに実行されるコールバック関数
				//msgにエラーメッセージが返却される
				errorHandler: function(msg){
					Util.showAlertToDiv("通信エラー: " + msg);
				}
			});


			//modalの設定
			$("#modal").on('show.bs.modal', function(){
				$("#newCardNameInput").val("");
				$("#newCardDescInput").val("");
				$("#newCardNameInput").focus();
			});

			$(".add-new-card-btn").on('click', function(){
		        var formData = $('#newCardForm').serializeJson();
		        console.log(formData);
				DashBoard.createCard(boardId, formData, {
					callback: function(ncard){
						Util.showAlertToDiv(ncard.name + "を追加しました", "success");
					},
					errorHandler: Util.showAlertToDiv
				});
			});
		});
		</script>


	</body>
</html>